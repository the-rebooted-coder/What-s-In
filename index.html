<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta property="og:type" content="website">
    <meta property="og:title" content="What's In...">
    <meta property="og:description" content="Instant PG menu tracker. Check what's for food right now.">
    <meta property="og:image" content="./icons/og-share.png">
    <meta property="og:url" content="https://the-rebooted-coder.github.io/What-s-In/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="What's In...">
    <meta name="twitter:description" content="Instant PG menu tracker. Check what's for food right now.">
    <meta name="twitter:image" content="./icons/og-share.png">
    
    <title>What's In...</title>
    <meta name="description" content="Weekly PG Menu Tracker. Instantly check what's for food based on the time of day.">
    <meta name="theme-color" content="#FFFDF0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="What's In">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">

    <style>
        :root {
            --bg-color: #FFFDF0;
            --accent: #FF6B6B;
            --primary: #4ECDC4;
            --secondary: #FFE66D;
            --neutral: #E0E0E0;
            --border: 4px solid #000000;
            --shadow: 6px 6px 0px 0px #000000;
            --shadow-active: 2px 2px 0px 0px #000000;
            --font-main: 'Courier New', Courier, monospace;
            --font-display: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: #000;
            font-family: var(--font-main);
            margin: 0;
            padding: 0; 
            min-height: 100vh;
            overscroll-behavior-y: none;
        }

        /* --- APP CONTAINER --- */
        #app-container {
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px;
        }

        /* --- INSTALL WALL --- */
        #install-wall {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            padding: 30px;
            background-color: var(--secondary);
            text-align: center;
            position: fixed;
            top: 0; left: 0;
            z-index: 9999;
        }

        .wall-title {
            font-family: var(--font-display);
            font-size: 3rem;
            line-height: 0.9;
            margin-bottom: 20px;
            text-transform: uppercase;
            border-bottom: var(--border);
            padding-bottom: 10px;
        }

        .wall-subtitle { font-weight: bold; font-size: 1.2rem; margin-bottom: 30px; }

        .instruction-card {
            background: white; border: var(--border); box-shadow: var(--shadow);
            padding: 20px; max-width: 400px; width: 100%;
        }

        .step-num {
            background: black; color: white; padding: 2px 8px;
            font-weight: bold; margin-right: 10px; border-radius: 2px;
        }

        .step { margin: 15px 0; text-align: left; display: flex; align-items: center; }
        
        #ios-content, #android-content, #desktop-content { display: none; }

        /* TYPOGRAPHY FOR APP */
        h1 {
            font-family: var(--font-display);
            font-size: 3.5rem;
            margin: 0 0 20px 0;
            letter-spacing: -1px; 
            text-align: center;
            line-height: 1.1; 
            text-transform: uppercase;
        }

        h2 { font-family: var(--font-display); font-size: 2rem; margin: 0 0 10px 0; text-transform: uppercase; }

        .label {
            background: #000; color: #fff; padding: 5px 10px;
            font-weight: bold; font-size: 0.9rem; display: inline-block;
            margin-bottom: 10px;
        }

        /* APP CARDS */
        .card {
            background: white; border: var(--border); box-shadow: var(--shadow);
            padding: 20px; width: 100%; max-width: 500px; margin-bottom: 20px;
        }

        #loading-panel, #display-panel, #expired-panel, #error-panel { display: none; }

        button {
            background: var(--primary); border: var(--border); box-shadow: var(--shadow);
            color: black; font-family: var(--font-display); font-size: 1.5rem;
            padding: 15px 20px; width: 100%; cursor: pointer;
            text-transform: uppercase; margin-bottom: 10px;
        }
        button:active { box-shadow: var(--shadow-active); transform: translate(4px, 4px); }
        button.retry-btn { background: var(--secondary); }
        button.update-btn { width: auto; padding: 5px 15px; font-size: 1.2rem; margin: 0; }
        
        /* NEW: Full Menu Button Style */
        button.full-menu-btn {
            background: white;
            font-size: 1.2rem;
            margin-top: 20px;
            padding: 10px;
        }

        .header-row {
            display: flex; justify-content: space-between; align-items: start;
            border-bottom: var(--border); padding-bottom: 15px; margin-bottom: 15px;
        }

        .date-group { display: flex; flex-direction: column; }
        .big-day { font-size: 1.5rem; font-weight: 900; line-height: 1; }
        .specific-date { font-size: 1rem; font-weight: bold; color: #666; margin-top: 5px;}

        .meal-type {
            font-size: 3rem; line-height: 1; font-family: var(--font-display);
            color: var(--accent); margin-bottom: 10px; word-break: break-word;
        }

        .food-items { font-size: 1.5rem; font-weight: bold; line-height: 1.3; }

        .expired-msg { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
        .last-synced { font-size: 0.8rem; color: #666; margin-bottom: 10px; display: block;}
        
        #offline-badge {
            display: none; background: #000; color: white; padding: 5px; font-size: 0.8rem;
            margin-bottom: 10px; font-weight: bold;
        }

        #update-toast {
            display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: var(--secondary); border: var(--border); box-shadow: var(--shadow);
            padding: 15px; z-index: 1000; text-align: center;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        #update-toast h3 { margin: 0 0 10px 0; font-family: var(--font-display); font-size: 1.5rem; text-transform: uppercase; }
        #update-toast button { background: var(--accent); color: white; font-size: 1.2rem; padding: 10px; margin: 0; width: 100%; }

        /* --- NEW: FULL MENU MODAL STYLES --- */
        #full-menu-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85); /* Dark dim */
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-card {
            background: var(--bg-color);
            border: var(--border);
            box-shadow: var(--shadow);
            width: 100%; max-width: 500px;
            max-height: 85vh;
            display: flex; flex-direction: column;
        }

        .modal-header {
            background: var(--secondary);
            border-bottom: var(--border);
            padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .modal-title { font-family: var(--font-display); font-size: 1.5rem; text-transform: uppercase; }

        .close-btn {
            background: var(--accent); width: auto; font-size: 1rem; padding: 5px 15px; margin: 0; box-shadow: 3px 3px 0 0 #000;
        }
        .close-btn:active { box-shadow: 1px 1px 0 0 #000; transform: translate(2px, 2px); }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .menu-row {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #000;
        }
        .menu-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .menu-label {
            display: inline-block; background: #000; color: #fff; 
            font-weight: bold; padding: 3px 8px; font-size: 0.8rem; margin-bottom: 5px;
        }
        .menu-content { font-size: 1.2rem; font-weight: bold; line-height: 1.3; }

    </style>
</head>
<body>

    <div id="install-wall">
        <div class="wall-title">YOU'RE DOING IT WRONG</div>
        <div class="wall-subtitle">This isn't a website. It's an app.<br>Install it or get out.</div>

        <div id="ios-content" class="instruction-card">
            <h3>iOS INSTRUCTIONS</h3>
            <div class="step"><span class="step-num">1</span>Tap the Share button. (The box vomiting an arrow).</div>
            <div class="step"><span class="step-num">2</span>Scroll down to "Add to Home Screen".</div>
            <div class="step"><span class="step-num">3</span>Stop using Safari like a casual.</div>
        </div>

        <div id="android-content" class="instruction-card">
            <h3>ANDROID INSTRUCTIONS</h3>
            <div class="step"><span class="step-num">1</span>Tap the three dots (Menu).</div>
            <div class="step"><span class="step-num">2</span>Tap "Install App" or "Add to Home Screen".</div>
            <div class="step"><span class="step-num">3</span>Welcome to civilization.</div>
        </div>

        <div id="desktop-content" class="instruction-card">
            <h3>DESKTOP? REALLY?</h3>
            <p>Go find your phone. This app is for people with lives.</p>
            <p style="font-size: 0.8rem; margin-top: 10px;">(Or if you must, use Chrome → Install App)</p>
        </div>
    </div>

    <div id="app-container">
        <h1>WHAT'S<br>IN...</h1>
        
        <div id="offline-badge">YOU ARE OFFLINE - SHOWING CACHED MENU</div>

        <div id="loading-panel" class="card" style="text-align: center;">
            <h2>Syncing...</h2>
            <p>Fetching latest menu from cloud.</p>
        </div>

        <div id="expired-panel" class="card" style="text-align: center; border-color: var(--accent);">
            <div class="label" style="background: var(--accent);">MENU EXPIRED</div>
            <h2>Week Over</h2>
            <p class="expired-msg">The menu currently available is for the past week.</p>
            <p>Waiting for new menu update...</p>
            <button onclick="fetchMenu()" class="retry-btn">Check for Update</button>
        </div>

        <div id="error-panel" class="card" style="text-align: center;">
            <h2>Connection Error</h2>
            <p id="error-text">Could not reach GitHub.</p>
            <button onclick="fetchMenu()" class="retry-btn">Retry</button>
        </div>

        <div id="display-panel" class="card">
            <div class="header-row">
                <div class="date-group">
                    <span class="label">UPCOMING MEAL</span>
                    <span class="big-day" id="display-day">MONDAY</span>
                    <span class="specific-date" id="display-date">Dec 01</span>
                </div>
                <button onclick="fetchMenu()" class="update-btn">↻</button>
            </div>

            <div class="meal-type" id="display-type">LUNCH</div>
            <div class="food-items" id="display-food">Loading...</div>
            <span class="last-synced" id="meta-info"></span>

            <button onclick="openFullMenu()" class="full-menu-btn">VIEW FULL MENU</button>
        </div>

        <div id="update-toast">
            <h3>New Version Available</h3>
            <p style="margin-bottom: 10px; font-weight: bold;">Fresh code just dropped.</p>
            <button id="reload-btn">UPDATE NOW</button>
        </div>
    </div>

    <div id="full-menu-modal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title" id="modal-day-title">MONDAY</span>
                <button class="close-btn" onclick="closeFullMenu()">X</button>
            </div>
            <div class="modal-body" id="modal-list">
                </div>
        </div>
    </div>

    <script>
        // --- DEVICE & STANDALONE DETECTION ---
        function checkMode() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                 window.navigator.standalone || 
                                 document.referrer.includes('android-app://');

            const wall = document.getElementById('install-wall');
            const app = document.getElementById('app-container');

            if (isStandalone) {
                wall.style.display = 'none';
                app.style.display = 'flex';
                initApp(); 
            } else {
                wall.style.display = 'flex';
                app.style.display = 'none';
                
                const ua = navigator.userAgent;
                if (/android/i.test(ua)) {
                    document.getElementById('android-content').style.display = 'block';
                } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                    document.getElementById('ios-content').style.display = 'block';
                } else {
                    document.getElementById('desktop-content').style.display = 'block';
                }
            }
        }

        // --- APP LOGIC ---
        let newWorker; 
        const MENU_URL = "https://gist.githubusercontent.com/the-rebooted-coder/b2d795d38fff48d9aa4e15e65d818262/raw/menu.json";
        const TIME_LIMITS = { breakfast: 11, lunch: 15, snacks: 18, dinner: 22 };
        const DAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        let panels, els;
        
        // Store current day's full menu here
        let currentDayMenuData = null; 
        let currentDayNameStr = "";

        function initApp() {
            panels = {
                loading: document.getElementById('loading-panel'),
                display: document.getElementById('display-panel'),
                expired: document.getElementById('expired-panel'),
                error: document.getElementById('error-panel')
            };
            
            els = {
                day: document.getElementById('display-day'),
                date: document.getElementById('display-date'),
                type: document.getElementById('display-type'),
                food: document.getElementById('display-food'),
                meta: document.getElementById('meta-info'),
                errText: document.getElementById('error-text'),
                // Modal refs
                modal: document.getElementById('full-menu-modal'),
                modalTitle: document.getElementById('modal-day-title'),
                modalList: document.getElementById('modal-list')
            };

            // Register SW
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('SW Registered');
                    if (reg.waiting) {
                        newWorker = reg.waiting;
                        showUpdateNotification();
                    }
                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                }).catch(err => console.log('SW Fail', err));

                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            }

            window.addEventListener('offline', () => document.getElementById('offline-badge').style.display = 'block');
            window.addEventListener('online', () => {
                document.getElementById('offline-badge').style.display = 'none';
                fetchMenu();
            });

            fetchMenu();
        }

        function showUpdateNotification() {
            const toast = document.getElementById('update-toast');
            toast.style.display = 'block';
            document.getElementById('reload-btn').addEventListener('click', () => {
                if(newWorker) newWorker.postMessage({ action: 'skipWaiting' });
            });
        }

        async function fetchMenu() {
            showPanel('loading');
            try {
                const uniqueUrl = MENU_URL + '?t=' + new Date().getTime();
                let data;
                try {
                    const response = await fetch(uniqueUrl);
                    if (!response.ok) throw new Error("Server Error");
                    data = await response.json();
                    localStorage.setItem('cached_menu', JSON.stringify(data));
                } catch (netErr) {
                    console.log("Network failed, checking cache");
                    const cached = localStorage.getItem('cached_menu');
                    if (cached) {
                        data = JSON.parse(cached);
                        document.getElementById('offline-badge').style.display = 'block';
                    } else {
                        throw netErr;
                    }
                }
                
                if (!data.meta || !data.meta.weekStart || !data.menu) throw new Error("Invalid Menu Format");

                const validity = checkDateValidity(data.meta.weekStart);
                if (validity === 'EXPIRED') showPanel('expired');
                else renderDisplay(data, validity === 'UPCOMING');

            } catch (err) {
                console.error(err);
                els.errText.innerText = err.message || "Network Error";
                showPanel('error');
            }
        }

        function checkDateValidity(weekStartStr) {
            const parts = weekStartStr.split('-');
            const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            const now = new Date();
            if (now > endDate) return 'EXPIRED';
            else if (now < startDate) return 'UPCOMING';
            return 'CURRENT';
        }

        function renderDisplay(data, isUpcoming) {
            showPanel('display');
            const now = new Date();
            let dayIndex = now.getDay();
            let hour = now.getHours();
            let targetMeal = "";
            let displayDayIndex = dayIndex;

            if (isUpcoming) {
                targetMeal = "Breakfast";
                displayDayIndex = 1; 
            } else {
                if (hour < TIME_LIMITS.breakfast) targetMeal = "Breakfast";
                else if (hour < TIME_LIMITS.lunch) targetMeal = "Lunch";
                else if (hour < TIME_LIMITS.snacks) targetMeal = "Snacks";
                else if (hour < TIME_LIMITS.dinner) targetMeal = "Dinner";
                else {
                    targetMeal = "Breakfast";
                    displayDayIndex = (dayIndex + 1) % 7;
                }
            }

            const dayName = DAYS[displayDayIndex];
            
            // SAVE DATA FOR MODAL
            currentDayNameStr = dayName;
            currentDayMenuData = data.menu[dayName];

            const startParts = data.meta.weekStart.split('-');
            const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
            let offset = (displayDayIndex + 6) % 7;
            const displayDate = new Date(startDate);
            displayDate.setDate(startDate.getDate() + offset);
            const dateString = displayDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });

            let foodText = "Not listed";
            if (data.menu[dayName] && data.menu[dayName][targetMeal]) {
                foodText = data.menu[dayName][targetMeal];
            }

            els.day.innerText = dayName.toUpperCase();
            els.date.innerText = dateString;
            els.type.innerText = targetMeal.toUpperCase();
            els.food.innerText = foodText;
            els.meta.innerText = "Week of " + data.meta.weekStart;
        }

        function showPanel(name) {
            Object.values(panels).forEach(p => p.style.display = 'none');
            panels[name].style.display = 'block';
        }

        // --- FULL MENU FUNCTIONS ---
        function openFullMenu() {
            if (!currentDayMenuData) return;

            els.modalTitle.innerText = currentDayNameStr.toUpperCase() + " MENU";
            els.modalList.innerHTML = ''; // Clear previous

            const mealsOrder = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];
            
            mealsOrder.forEach(meal => {
                const food = currentDayMenuData[meal] || "Not listed";
                
                const row = document.createElement('div');
                row.className = 'menu-row';
                
                const label = document.createElement('div');
                label.className = 'menu-label';
                label.innerText = meal.toUpperCase();
                
                const content = document.createElement('div');
                content.className = 'menu-content';
                content.innerText = food;

                row.appendChild(label);
                row.appendChild(content);
                els.modalList.appendChild(row);
            });

            els.modal.style.display = 'flex';
        }

        function closeFullMenu() {
            els.modal.style.display = 'none';
        }

        // --- RUN THE CHECK ON LOAD ---
        window.addEventListener('load', checkMode);

    </script>
</body>
</html>